<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script language="JavaScript" src="js/common.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/jquery-1.8.1.js" type="text/javascript"></script>
    <!--
    <script language="JavaScript" src="js/jquery-ui-1.8.23.custom.min.js" type="text/javascript"></script>-
    -->
</head>

<body style="padding:0;margin:0" class="">

    <script language="JavaScript" src="js/event.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/carts.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/basic.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/vic20.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/vic6560.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/via6522.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/keyboard.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/tapedrive.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/cpu6502.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/cpu6502disassemble.js" type="text/javascript"></script>
    <script language="JavaScript" src="js/cpu6502assemble.js" type="text/javascript"></script>

<script>
    function fullscreen(noWarningForNotSupported) {
		var isFullScreen = document.mozFullScreen || document.webkitIsFullScreen;
		if (!isFullScreen) {
			var elem = document.getElementById("canvasfs");
			var canvasElem = document.getElementById("canvas");
			
			if (!$(elem).is(":visible")) {
				alert("You cannot go fullscreen in debug mode");
				return;
			}
			if (elem.requestFullScreen) {  
				elem.requestFullScreen();  
			} else if (elem.mozRequestFullScreen) {  
				elem.mozRequestFullScreen();
				elem.style.height="100%";
				canvasElem.style.height="100%";
			} else if (elem.webkitRequestFullScreen) {  
				elem.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);  
				elem.style.height="100%";
				elem.style.width="100%";
				canvasElem.style.height="100%";
			} else {
				if (!(noWarningForNotSupported==true)) alert("Fullscreen not supported. Try Firefox or Chrome.");
			}
		} else {
			var elem = document.getElementById("canvas");  
			if (document.cancelFullScreen) {  
				document.cancelFullScreen();
			} else if (document.mozCancelFullScreen) {  
				document.mozCancelFullScreen();
				elem.style.height="";
			} else if (document.webkitCancelFullScreen) {  
				document.webkitCancelFullScreen();  
				elem.style.height="";
			}
		}
    }
</script>


    <div id="canvasfs" style="background-color:#000">
    <canvas id="canvas" width="1" height="1" style="display:block;margin-left:auto;margin-right:auto" onclick="fullscreen(true)">&#160;</canvas>
    </div>

<script>
vic20 = new Vic20();
var machineType = getURLParameter("machineType");
if (machineType=="pal") {vic20.isPal=true;kerneldata=kerneldataPal;machineType="pal";}

/*if (machineType=="ntsc") */ else {vic20.isPal=false;kerneldata=kerneldataNtsc;}


vic20.init();
vic20.execute();

var url = getURLParameter("load");
var urlmem = getURLParameter("mem");

if (url && url!="" && url!=null && url!="null") {
	if (url.indexOf(".csm")!=-1 || url.indexOf(".tap")!=-1) {
		externalLoad("loadTape",url)
	} else {
		externalLoad("loadPrg",url);
	}
}

function externalLoad(cmd,url,format, subfile) {
	//$("#selectZipFile").dialog("close");
	console.debug("externalLoad cmd="+cmd+" url="+url+" format="+format+" subfile="+subfile);
	fullscreen(true);
	if (format) {
		if(format=="pal") {
			vic20.isPal=true;kerneldata=kerneldataPal;
		}
		if(format=="ntsc") {
			vic20.isPal=false;kerneldata=kerneldataNtsc;
		}
	}
	var head= document.getElementsByTagName('head')[0];
	var script= document.createElement('script');
	script.type= 'text/javascript';
	// TODO encode
	script.src= 'vic20/prgtojsloader.php?cmd='+cmd+'&prgurl='+url+'&subfile='+subfile;
	head.appendChild(script);
}

function loadTapeCustom(tapeUrl) {
	if (!tapeUrl) tapeUrl = window.prompt("Enter the URL to the tape including http://\nSupported formats are csm,tap,csm.gz, and tap.gz");
	if (tapeUrl) {
		externalLoad("loadTape",tapeUrl);
	}
}

function loadTape(binhex) {
	EventManager.event(EventTape.createInsertEvent(binToArray(binhex[0])));
	if (urlmem) {
		Config.memoryAt0400 = Config.memoryAt2000 = Config.memoryAt4000 = Config.memoryAt6000 = Config.memoryAtA000 = false;
		if (urlmem=="3k") Config.memoryAt0400 = true;
		if (urlmem=="24k") Config.memoryAt2000 = Config.memoryAt4000 = Config.memoryAt6000 = true;
		if (urlmem=="32k") Config.memoryAt2000 = Config.memoryAt4000 = Config.memoryAt6000 = Config.memoryAtA000 = true;
		urlmem = undefined;
	}
	vic20.softreset();
	loadPrgSrc="tape";
}

function loadCartCustom() {
	var cartUrl = window.prompt("Enter the URL to the cart including the http://");
	if (cartUrl) {
		externalLoad("loadPrg",cartUrl);
	}
}

function loadPrgCustom() {
	var cartUrl = window.prompt("Enter the URL to the prg including the http://");
	if (cartUrl) {
		externalLoad("loadPrg",cartUrl);
	}
}

function chooseZipFile(options) {
	validOptions = new Array();
	for(var i=0; i<options.length; i++) {
		if (options[i].indexOf(".prg")!=-1) {
			$("#selectZipFiles").append($('<a>'+options[i]+'</a>').attr('href',"javascript:externalLoad(\'loadPrg\',\'"+url+"\',\'"+machineType+"\',\'"+options[i]+"\');")).append("<br/>");
			validOptions.push(options[i]);
		}
	}
	if (validOptions.length==0) {
		alert("Sorry, no .prg files found in zip");
	}
	else if (validOptions.length==1) {
		externalLoad('loadPrg',url,machineType,validOptions[0]);
	}
	else {
		$("#selectZipFile").dialog();
	}
}
</script>
<div id="selectZipFile" style="display:none">
Select a file from the zip to open:
<div id="selectZipFiles">
</div>
</div>
<script>
function updateMenuState() {
	$("#joykeysopt").prop("checked", Config.joykeys);
	$("#joykeysopt2").prop("checked", Config.joykeys);

	$("#mem0400opt").prop("checked", Config.memoryAt0400);
	$("#mem2000opt").prop("checked", Config.memoryAt2000);
	$("#mem4000opt").prop("checked", Config.memoryAt4000);
	$("#mem6000opt").prop("checked", Config.memoryAt6000);
	$("#memA000opt").prop("checked", Config.memoryAtA000);
	
	$("#speedopt100").prop("checked", Config.speed==1);
	$("#speedoptNoLimit").prop("checked", Config.speed!=1);
	
	$("#ntscUsaOpt").prop("checked",   kerneldata==kerneldataNtsc && chardata==chardataEnglish);
	$("#ntscJapanOpt").prop("checked", kerneldata==kerneldataNtsc && chardata==chardataJapan);
	$("#palWorldOpt").prop("checked",  kerneldata==kerneldataPal && chardata==chardataEnglish);
	$("#palSweFiOpt").prop("checked",  kerneldata==kerneldataPal && chardata==chardataSwedenFinland);
}

updateMenuState();

function playTape() {
	Config.tapePlay=true;
	updateDatasetteView();	
}

function stopTape() {
	Config.tapePlay=false;
	updateDatasetteView();	
}

function datasetteMouseClick() {
	$('#tapeZoom').dialog({width:300,height:440,position:{my:"left",at:"left",of:$("#datasettesmall")}});
	updateDatasetteView();
}

function updateDatasetteView(event) {
	if (event && event.filepath) {
		datasetteMouseClick();
	}
	$("#datasette_empty,#datasette_stopped,#datasette_play").hide();
	if (Config.tapePlay) {
		$("#datasette_play").show();
		$("#datasette_empty,#datasette_stopped").hide();
	} else if (vic20.tapedrive.isTapeLoaded()) {
		$("#datasette_stopped").show();
		$("#datasette_empty,#datasette_play").hide();
	} else {
		$("#datasette_empty").show();
		$("#datasette_stopped,#datasette_play").hide();
	}
}

EventManager.listen("EventTape", updateDatasetteView);

function pasteBasicProgram() {
	KeyboardUnhook();
	$("#basicDialog").dialog({
			title: 'Basic Listing',
			width: 700,
			height: 300,
			close: function(event, ui) { KeyboardHook(); loadPrgFromBasicString($("#pasteBasic").val()); return true; }
	});
	$("#pasteBasic").val(memoryToAsciiBasic(mem));
}

var assembler = new Cpu6502assembler();

function pasteAssemblerProgram() {
	KeyboardUnhook();
	$("#assemblerDialog").dialog({
			title: 'Assembler Listing',
			width: 'auto',
			close: function(event, ui) {
				KeyboardHook();
				return true;
			}
	});
}

function compile() {
	var result = assembler.compile($("#pasteAssembler").val());
	var fb = "";
	for(var i=0; i<result.feedback.length; i++) {
		fb += result.feedback[i].message + "\n";
	}
	$("#assemblerFeedback").val(fb);
	if (result.success) {
		for(var i=0; i<65536; i++) {
			if (result.m[i]!==undefined) {
				mem[i] = result.m[i];
				memExec[i] = 2;
			}
		}
	}
}
</script>
<div id="basicDialog" style="display:none">
<p>Paste/Type your program then close this dialog:</p><p>
<textarea id="pasteBasic" style="width:100%;height:100%;">&nbsp;</textarea>
</p></div>



<div class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-draggable ui-resizable" tabindex="-1" role="dialog" aria-labelledby="ui-dialog-title-assemblerDialog" style="display: none; z-index: 1002; outline: 0px; position: absolute; height: auto; width: auto; top: 21.5px; left: 354.5px;"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title" id="ui-dialog-title-assemblerDialog">Assembler Listing</span><a href="https://www.mdawson.net/vic20chrome/vic20.php#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div><div id="assemblerDialog" style="width: auto; min-height: 109.28px; height: auto;" class="ui-dialog-content ui-widget-content" scrolltop="0" scrollleft="0">
Paste/Type your assembler here:<br>
<textarea id="pasteAssembler" style="width:600px;height:300px;"></textarea><br>
<button onclick="compile()">Compile</button>(automatically copies to memory on success)<br>
Compiler Output:<br>
<textarea id="assemblerFeedback" style="width:600px;height:100px;"></textarea>
</div><div class="ui-resizable-handle ui-resizable-n" style="z-index: 1000;"></div><div class="ui-resizable-handle ui-resizable-e" style="z-index: 1000;"></div><div class="ui-resizable-handle ui-resizable-s" style="z-index: 1000;"></div><div class="ui-resizable-handle ui-resizable-w" style="z-index: 1000;"></div><div class="ui-resizable-handle ui-resizable-se ui-icon ui-icon-gripsmall-diagonal-se ui-icon-grip-diagonal-se" style="z-index: 1000;"></div><div class="ui-resizable-handle ui-resizable-sw" style="z-index: 1000;"></div><div class="ui-resizable-handle ui-resizable-ne" style="z-index: 1000;"></div><div class="ui-resizable-handle ui-resizable-nw" style="z-index: 1000;"></div></div></body></html>